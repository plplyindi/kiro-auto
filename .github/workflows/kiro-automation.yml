name: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æž

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹è¿è¡Œ (UTC 20:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
  schedule:
    - cron: '0 20 * * *'

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install requests

      - name: ä»Žé‚®ç®±èŽ·å–å¾®ä¿¡æ–‡ç« é“¾æŽ¥
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          echo "ðŸ“§ å¼€å§‹ä»ŽQQé‚®ç®±èŽ·å–å¾®ä¿¡æ–‡ç« é“¾æŽ¥..."
          python scripts/email_fetcher.py

      - name: çˆ¬å–å¾®ä¿¡æ–‡ç« å†…å®¹
        run: |
          echo "ðŸ•·ï¸ å¼€å§‹çˆ¬å–å¾®ä¿¡æ–‡ç« å†…å®¹..."
          python scripts/article_scraper.py

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ç« 
        id: check_articles
        run: |
          if [ -f "articles_content.json" ] && [ -s "articles_content.json" ]; then
            echo "has_articles=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°æ–‡ç« å†…å®¹"
          else
            echo "has_articles=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ²¡æœ‰æ–‡ç« å†…å®¹"
          fi

      - name: å®‰è£… Claude Code CLI
        if: steps.check_articles.outputs.has_articles == 'true'
        run: |
          echo "å¼€å§‹å®‰è£… Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: éªŒè¯ Claude Code å®‰è£…
        if: steps.check_articles.outputs.has_articles == 'true'
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          claude --version

      - name: é…ç½® Claude Code
        if: steps.check_articles.outputs.has_articles == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          echo "é…ç½® Claude Code..."
          mkdir -p ~/.claude

          cat > ~/.claude/settings.json << 'EOFINNER'
          {
            "env": {
              "ANTHROPIC_BASE_URL": "${ANTHROPIC_BASE_URL:-https://api.anthropic.com}",
              "ANTHROPIC_API_KEY": "${ANTHROPIC_API_KEY}"
            }
          }
          EOFINNER

          sed -i "s|\${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|g" ~/.claude/settings.json
          sed -i "s|\${ANTHROPIC_API_KEY}|${ANTHROPIC_API_KEY}|g" ~/.claude/settings.json

          cat > ~/.claude/config.json << EOFINNER
          {
            "primaryApiKey": "${ANTHROPIC_API_KEY}"
          }
          EOFINNER

          cat > ~/.claude.json << 'EOFINNER'
          {
            "hasCompletedOnboarding": true
          }
          EOFINNER

          echo "âœ… Claude Code é…ç½®å®Œæˆ"

      - name: ç”¨Claudeåˆ†æžæ–‡ç« ï¼ˆå¸¦é‡è¯•ï¼‰
        if: steps.check_articles.outputs.has_articles == 'true'
        env:
          MAX_RETRIES: 3
          RETRY_DELAY: 10
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          echo "========================================="
          echo "   Claude Code æ–‡ç« åˆ†æžä»»åŠ¡å¼€å§‹"
          echo "========================================="
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo ""

          # åˆ›å»ºåˆ†æžä»»åŠ¡æç¤ºè¯
          cat > analysis_prompt.txt << 'EOFPROMPT'
          è¯·åˆ†æž articles_content.json æ–‡ä»¶ä¸­çš„å¾®ä¿¡å…¬ä¼—å·æ–‡ç« ï¼Œå¹¶ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„åˆ†æžæŠ¥å‘Šã€‚

          åˆ†æžè¦æ±‚ï¼š
          1. é˜…è¯»æ‰€æœ‰æ–‡ç« å†…å®¹
          2. æ€»ç»“æ¯ç¯‡æ–‡ç« çš„æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
          3. è¯†åˆ«æ–‡ç« çš„ä¸»é¢˜åˆ†ç±»ï¼ˆæŠ€æœ¯ã€äº§å“ã€è¡Œä¸šåŠ¨æ€ç­‰ï¼‰
          4. æå–æœ‰ä»·å€¼çš„æŠ€æœ¯çŸ¥è¯†ç‚¹æˆ–è§è§£
          5. å¦‚æžœæœ‰å¤šç¯‡æ–‡ç« ï¼Œæ‰¾å‡ºå®ƒä»¬ä¹‹é—´çš„å…³è”æ€§

          è¯·å°†åˆ†æžç»“æžœä¿å­˜åˆ° articles_analysis.md æ–‡ä»¶ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

          # å¾®ä¿¡å…¬ä¼—å·æ–‡ç« åˆ†æžæŠ¥å‘Š

          ç”Ÿæˆæ—¶é—´: [å½“å‰æ—¶é—´]

          ## ðŸ“Š æ€»ä½“æ¦‚å†µ
          - æ–‡ç« æ€»æ•°
          - ä¸»é¢˜åˆ†å¸ƒ
          - æ—¶é—´è·¨åº¦

          ## ðŸ“ æ–‡ç« è¯¦ç»†åˆ†æž

          ### [æ–‡ç« æ ‡é¢˜1]
          - ä½œè€…: 
          - å‘å¸ƒæ—¶é—´:
          - ä¸»é¢˜åˆ†ç±»:
          - æ ¸å¿ƒè§‚ç‚¹:
          - å…³é”®ä¿¡æ¯:
          - æŠ€æœ¯è¦ç‚¹:

          [å¯¹æ¯ç¯‡æ–‡ç« é‡å¤ä»¥ä¸Šæ ¼å¼]

          ## ðŸ’¡ ç»¼åˆæ´žå¯Ÿ
          - è¶‹åŠ¿åˆ†æž
          - é‡ç‚¹å…³æ³¨
          - è¡ŒåŠ¨å»ºè®®

          è¯·å¼€å§‹åˆ†æžã€‚
          EOFPROMPT

          echo "ðŸ“‹ åˆ†æžä»»åŠ¡ï¼š"
          cat analysis_prompt.txt
          echo ""
          echo "========================================="
          echo ""

          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ðŸš€ [å°è¯• $RETRY_COUNT/$MAX_RETRIES]"
            echo ""

            if claude -p "$(cat analysis_prompt.txt)"; then
              echo ""
              echo "âœ… åˆ†æžæˆåŠŸï¼"
              SUCCESS=true
              break
            else
              EXIT_CODE=$?
              echo ""
              echo "âŒ åˆ†æžå¤±è´¥ (é”™è¯¯ç : $EXIT_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åŽé‡è¯•..."
                sleep $RETRY_DELAY
                echo ""
              fi
            fi
          done

          echo ""
          echo "========================================="
          if [ "$SUCCESS" = true ]; then
            echo "   âœ… ä»»åŠ¡å®Œæˆ"
            echo "========================================="
            exit 0
          else
            echo "   âŒ ä»»åŠ¡å¤±è´¥ï¼ˆå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼‰"
            echo "========================================="
            exit 1
          fi

      - name: æäº¤åˆ†æžç»“æžœåˆ°ä»“åº“
        if: steps.check_articles.outputs.has_articles == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          else
            git commit -m "ðŸ“Š è‡ªåŠ¨æ›´æ–°å¾®ä¿¡æ–‡ç« åˆ†æž - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… å·²æäº¤åˆ†æžç»“æžœåˆ°ä»“åº“"
          fi

      - name: ä¸Šä¼ ä»»åŠ¡ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-results-${{ github.run_number }}
          path: |
            articles_*.json
            articles_*.md
            articles_*.txt
            *.log
          retention-days: 30

      - name: è¾“å‡ºé€šçŸ¥ä¿¡æ¯ï¼ˆæˆåŠŸï¼‰
        if: success()
        run: |
          echo "âœ… å¾®ä¿¡æ–‡ç« åˆ†æžå®Œæˆï¼"
          echo "è¿è¡Œç¼–å·: #${{ github.run_number }}"
          echo "å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo ""
          
          if [ -f "articles_analysis.md" ]; then
            echo "ðŸ“Š ç”Ÿæˆçš„åˆ†æžæŠ¥å‘Šï¼š"
            echo "---"
            head -50 articles_analysis.md
            echo "---"
          fi
          
          echo ""
          echo "ðŸ”— æŸ¥çœ‹å®Œæ•´ç»“æžœï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: è¾“å‡ºé€šçŸ¥ä¿¡æ¯ï¼ˆå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "âŒ å¾®ä¿¡æ–‡ç« åˆ†æžå¤±è´¥ï¼"
          echo "è¿è¡Œç¼–å·: #${{ github.run_number }}"
          echo "å¤±è´¥æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo ""
          echo "ðŸ” æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
