name: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æž

on:
  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Claude Code CLI
        run: |
          echo "å¼€å§‹å®‰è£… Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          # æ·»åŠ åˆ° PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: éªŒè¯ Claude Code å®‰è£…
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          claude --version

      - name: é…ç½® Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          echo "é…ç½® Claude Code..."

          # åˆ›å»ºé…ç½®ç›®å½•
          mkdir -p ~/.claude

          # 1. åˆ›å»º settings.json
          cat > ~/.claude/settings.json << 'EOF'
          {
            "env": {
              "ANTHROPIC_BASE_URL": "${ANTHROPIC_BASE_URL:-https://api.anthropic.com}",
              "ANTHROPIC_API_KEY": "${ANTHROPIC_API_KEY}"
            }
          }
          EOF

          # æ›¿æ¢çŽ¯å¢ƒå˜é‡
          sed -i "s|\${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|g" ~/.claude/settings.json
          sed -i "s|\${ANTHROPIC_API_KEY}|${ANTHROPIC_API_KEY}|g" ~/.claude/settings.json

          # 2. åˆ›å»º config.json
          cat > ~/.claude/config.json << EOF
          {
            "primaryApiKey": "${ANTHROPIC_API_KEY}"
          }
          EOF

          # 3. åˆ›å»º .claude.json
          cat > ~/.claude.json << 'EOF'
          {
            "hasCompletedOnboarding": true
          }
          EOF

          echo "âœ… Claude Code é…ç½®å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶ï¼š"
          echo "  - ~/.claude/settings.json"
          echo "  - ~/.claude/config.json"
          echo "  - ~/.claude.json"

      - name: æ‰§è¡Œ Claude Code ä»»åŠ¡ï¼ˆå¸¦é‡è¯•ï¼‰
        env:
          MAX_RETRIES: 3
          RETRY_DELAY: 10
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          echo "========================================="
          echo "   Claude Code è‡ªåŠ¨åŒ–ä»»åŠ¡å¼€å§‹"
          echo "========================================="
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo "UTCæ—¶é—´: $(date)"
          echo ""

          # æ£€æŸ¥ä»»åŠ¡æ–‡ä»¶
          if [ ! -f ".kiro/specs/tasks.md" ]; then
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»»åŠ¡æ–‡ä»¶ .kiro/specs/tasks.md"
            exit 1
          fi

          echo "ðŸ“‹ ä»»åŠ¡æ–‡ä»¶å†…å®¹ï¼š"
          cat .kiro/specs/tasks.md
          echo ""
          echo "========================================="
          echo ""

          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ðŸš€ [å°è¯• $RETRY_COUNT/$MAX_RETRIES]"
            echo ""

            # æ‰§è¡Œ Claude Codeï¼ˆ-p è¡¨ç¤º print/éžäº¤äº’æ¨¡å¼ï¼‰
            if claude -p "$(cat .kiro/specs/tasks.md)"; then
              echo ""
              echo "âœ… æ‰§è¡ŒæˆåŠŸï¼"
              SUCCESS=true
              break
            else
              EXIT_CODE=$?
              echo ""
              echo "âŒ æ‰§è¡Œå¤±è´¥ (é”™è¯¯ç : $EXIT_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åŽé‡è¯•..."
                sleep $RETRY_DELAY
                echo ""
              fi
            fi
          done

          echo ""
          echo "========================================="
          if [ "$SUCCESS" = true ]; then
            echo "   âœ… ä»»åŠ¡å®Œæˆ"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 0
          else
            echo "   âŒ ä»»åŠ¡å¤±è´¥ï¼ˆå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼‰"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 1
          fi

      - name: ä¸Šä¼ ä»»åŠ¡ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-results-${{ github.run_number }}
          path: |
            *.txt
            *.log
            *.md
          retention-days: 7

      - name: å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… æŠ€æœ¯æ–‡ç« åˆ†æžå®Œæˆ - è¿è¡Œ #${{ github.run_number }}"
          to: ${{ secrets.MAIL_TO }}
          from: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æžç³»ç»Ÿ
          body: |
            æŠ€æœ¯æ–‡ç« åˆ†æžä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼

            ðŸ“Š è¿è¡Œä¿¡æ¯ï¼š
            - è¿è¡Œç¼–å·: #${{ github.run_number }}
            - å®Œæˆæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - ä»“åº“: ${{ github.repository }}

            ðŸ“„ æŸ¥çœ‹è¯¦æƒ…ï¼š
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ðŸ“¦ ä¸‹è½½åˆ†æžæŠ¥å‘Šï¼š
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts

            ðŸ’¡ æç¤ºï¼š
            æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨çš„ "Artifacts" éƒ¨åˆ†ä¸‹è½½å®Œæ•´çš„åˆ†æžæŠ¥å‘Šã€‚

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¤±è´¥ï¼‰
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ æŠ€æœ¯æ–‡ç« åˆ†æžå¤±è´¥ - è¿è¡Œ #${{ github.run_number }}"
          to: ${{ secrets.MAIL_TO }}
          from: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æžç³»ç»Ÿ
          body: |
            æŠ€æœ¯æ–‡ç« åˆ†æžä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼

            âš ï¸ è¿è¡Œä¿¡æ¯ï¼š
            - è¿è¡Œç¼–å·: #${{ github.run_number }}
            - å¤±è´¥æ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - ä»“åº“: ${{ github.repository }}

            ðŸ” æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            å¯èƒ½çš„åŽŸå› ï¼š
            - API é…é¢ç”¨å®Œ
            - ç½‘ç»œè¿žæŽ¥é—®é¢˜
            - æ–‡ç« æ ¼å¼æ— æ³•è§£æž

            è¯·æ£€æŸ¥ Actions æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
