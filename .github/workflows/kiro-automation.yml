name: Claude Code è‡ªåŠ¨åŒ–ä»»åŠ¡

on:
  # æ¯å¤©ä¸‹åˆ5ç‚¹è¿è¡Œ (åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00)
  schedule:
    - cron: '0 9 * * *'

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Claude Code CLI
        run: |
          echo "å¼€å§‹å®‰è£… Claude Code CLI..."
          curl -fsSL https://raw.githubusercontent.com/anthropics/anthropic-quickstarts/main/claude-code/install.sh | bash
          echo "$HOME/.claude/bin" >> $GITHUB_PATH

      - name: éªŒè¯ Claude Code å®‰è£…
        run: |
          export PATH="$HOME/.claude/bin:$PATH"
          claude-code --version

      - name: æ‰§è¡Œ Claude Code ä»»åŠ¡ï¼ˆå¸¦é‡è¯•ï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MAX_RETRIES: 3
          RETRY_DELAY: 10
        run: |
          export PATH="$HOME/.claude/bin:$PATH"

          echo "========================================="
          echo "   Claude Code è‡ªåŠ¨åŒ–ä»»åŠ¡å¼€å§‹"
          echo "========================================="
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo "UTCæ—¶é—´: $(date)"
          echo ""

          # æ£€æŸ¥ä»»åŠ¡æ–‡ä»¶
          if [ ! -f ".kiro/specs/tasks.md" ]; then
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»»åŠ¡æ–‡ä»¶ .kiro/specs/tasks.md"
            exit 1
          fi

          echo "ğŸ“‹ ä»»åŠ¡æ–‡ä»¶å†…å®¹ï¼š"
          cat .kiro/specs/tasks.md
          echo ""
          echo "========================================="
          echo ""

          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ğŸš€ [å°è¯• $RETRY_COUNT/$MAX_RETRIES]"
            echo ""

            # æ‰§è¡Œ Claude Code
            if claude-code chat --non-interactive "$(cat .kiro/specs/tasks.md)"; then
              echo ""
              echo "âœ… æ‰§è¡ŒæˆåŠŸï¼"
              SUCCESS=true
              break
            else
              EXIT_CODE=$?
              echo ""
              echo "âŒ æ‰§è¡Œå¤±è´¥ (é”™è¯¯ç : $EXIT_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åé‡è¯•..."
                sleep $RETRY_DELAY
                echo ""
              fi
            fi
          done

          echo ""
          echo "========================================="
          if [ "$SUCCESS" = true ]; then
            echo "   âœ… ä»»åŠ¡å®Œæˆ"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 0
          else
            echo "   âŒ ä»»åŠ¡å¤±è´¥ï¼ˆå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼‰"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 1
          fi

      - name: ä¸Šä¼ ä»»åŠ¡ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-results-${{ github.run_number }}
          path: |
            *.txt
            *.log
            *.md
          retention-days: 7

      - name: å‘é€é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
        if: success()
        run: |
          echo "âœ… Claude Code ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date)"

      - name: å‘é€é€šçŸ¥ï¼ˆå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "âŒ Claude Code ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "è¯·æ£€æŸ¥ Actions æ—¥å¿—"
