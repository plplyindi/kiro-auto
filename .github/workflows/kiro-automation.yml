name: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æ

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 20 * * *'
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“scriptsç›®å½•æœ‰æ–°æäº¤æ—¶è§¦å‘
  push:
    paths:
      - 'scripts/**'
      - 'articles/**'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  actions: read

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½®Gité…ç½®
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install requests beautifulsoup4 lxml anthropic
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ç« 
        id: check_articles
        run: |
          if [ -f "scripts/articles_"*".json" ]; then
            echo "has_articles=true" >> $GITHUB_OUTPUT
            echo "[OK] Found article files"
            ls -lh scripts/articles_*.json
          else
            echo "has_articles=false" >> $GITHUB_OUTPUT
            echo "[INFO] No article files found"
          fi
      
      - name: ç”¨Claudeåˆ†ææ–‡ç« 
        if: steps.check_articles.outputs.has_articles == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > analyze.py << 'PYSCRIPT'
import json
import os
from datetime import datetime
from anthropic import Anthropic

client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

# è¯»å–æœ€æ–°çš„æ–‡ç« æ–‡ä»¶
import glob
article_files = glob.glob('scripts/articles_*.json')
if not article_files:
    print("[ERROR] No article files found")
    exit(1)

latest_file = max(article_files, key=os.path.getmtime)
print(f"[INFO] Analyzing: {latest_file}")

with open(latest_file, 'r', encoding='utf-8') as f:
    articles = json.load(f)

print(f"[INFO] Found {len(articles)} articles")

# æ„å»ºæç¤ºè¯
prompt = f"""è¯·åˆ†æä»¥ä¸‹{len(articles)}ç¯‡å¾®ä¿¡å…¬ä¼—å·æ–‡ç« ï¼Œç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Šï¼š

"""

for i, article in enumerate(articles, 1):
    prompt += f"""
## æ–‡ç« {i}: {article['title']}
ä½œè€…: {article.get('author', 'Unknown')}
é“¾æ¥: {article['url']}
å†…å®¹: {article['content'][:2000]}
{'...(å†…å®¹è¿‡é•¿å·²æˆªæ–­)' if len(article['content']) > 2000 else ''}

"""

prompt += """
è¯·ç”Ÿæˆä¸€ä»½Markdownæ ¼å¼çš„åˆ†ææŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š

1. æ€»ä½“æ¦‚å†µï¼ˆæ–‡ç« æ•°é‡ã€ä¸»é¢˜åˆ†å¸ƒï¼‰
2. æ¯ç¯‡æ–‡ç« çš„æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
3. æŠ€æœ¯è¦ç‚¹æå–
4. ç»¼åˆæ´å¯Ÿå’Œå»ºè®®

è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è¯»ã€‚
"""

# è°ƒç”¨Claude API
print("[INFO] Calling Claude API...")
message = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=4096,
    messages=[{"role": "user", "content": prompt}]
)

analysis = message.content[0].text
print("[OK] Analysis completed")

# ä¿å­˜åˆ†ææŠ¥å‘Š
output_file = f"analyzed/analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
os.makedirs('analyzed', exist_ok=True)

with open(output_file, 'w', encoding='utf-8') as f:
    f.write(f"# å¾®ä¿¡å…¬ä¼—å·æ–‡ç« åˆ†ææŠ¥å‘Š\n\n")
    f.write(f"**ç”Ÿæˆæ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
    f.write(f"**æ–‡ç« æ¥æº**: {latest_file}\n\n")
    f.write("---\n\n")
    f.write(analysis)

print(f"[OK] Saved to {output_file}")
print(f"\n{analysis[:500]}...")
PYSCRIPT
          
          python analyze.py
      
      - name: æäº¤åˆ†æç»“æœ
        if: steps.check_articles.outputs.has_articles == 'true'
        run: |
          git add analyzed/
          
          if git diff --staged --quiet; then
            echo "[INFO] No changes to commit"
          else
            git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°æ–‡ç« åˆ†æ - $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "[OK] Analysis committed and pushed"
          fi
      
      - name: ä¸Šä¼ ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results-${{ github.run_number }}
          path: |
            analyzed/*.md
            scripts/articles_*.json
          retention-days: 30
