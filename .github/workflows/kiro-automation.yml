name: Claude Code æŠ€æœ¯æ–‡ç« åˆ†æž

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹è¿è¡Œ (UTC 20:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
  schedule:
    - cron: '0 20 * * *'

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Claude Code CLI
        run: |
          echo "å¼€å§‹å®‰è£… Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          # æ·»åŠ åˆ° PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: éªŒè¯ Claude Code å®‰è£…
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          claude --version

      - name: é…ç½® Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          echo "é…ç½® Claude Code..."

          # åˆ›å»ºé…ç½®ç›®å½•
          mkdir -p ~/.claude

          # 1. åˆ›å»º settings.json
          cat > ~/.claude/settings.json << 'EOFINNER'
          {
            "env": {
              "ANTHROPIC_BASE_URL": "${ANTHROPIC_BASE_URL:-https://api.anthropic.com}",
              "ANTHROPIC_API_KEY": "${ANTHROPIC_API_KEY}"
            }
          }
          EOFINNER

          # æ›¿æ¢çŽ¯å¢ƒå˜é‡
          sed -i "s|\${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|${ANTHROPIC_BASE_URL:-https://api.anthropic.com}|g" ~/.claude/settings.json
          sed -i "s|\${ANTHROPIC_API_KEY}|${ANTHROPIC_API_KEY}|g" ~/.claude/settings.json

          # 2. åˆ›å»º config.json
          cat > ~/.claude/config.json << EOFINNER
          {
            "primaryApiKey": "${ANTHROPIC_API_KEY}"
          }
          EOFINNER

          # 3. åˆ›å»º .claude.json
          cat > ~/.claude.json << 'EOFINNER'
          {
            "hasCompletedOnboarding": true
          }
          EOFINNER

          echo "âœ… Claude Code é…ç½®å®Œæˆ"
          echo "é…ç½®æ–‡ä»¶ï¼š"
          echo "  - ~/.claude/settings.json"
          echo "  - ~/.claude/config.json"
          echo "  - ~/.claude.json"

      - name: æ‰§è¡Œ Claude Code ä»»åŠ¡ï¼ˆå¸¦é‡è¯•ï¼‰
        env:
          MAX_RETRIES: 3
          RETRY_DELAY: 10
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          echo "========================================="
          echo "   Claude Code è‡ªåŠ¨åŒ–ä»»åŠ¡å¼€å§‹"
          echo "========================================="
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo "UTCæ—¶é—´: $(date)"
          echo ""

          # æ£€æŸ¥ä»»åŠ¡æ–‡ä»¶
          if [ ! -f ".kiro/specs/tasks.md" ]; then
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»»åŠ¡æ–‡ä»¶ .kiro/specs/tasks.md"
            exit 1
          fi

          echo "ðŸ“‹ ä»»åŠ¡æ–‡ä»¶å†…å®¹ï¼š"
          cat .kiro/specs/tasks.md
          echo ""
          echo "========================================="
          echo ""

          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ðŸš€ [å°è¯• $RETRY_COUNT/$MAX_RETRIES]"
            echo ""

            # æ‰§è¡Œ Claude Codeï¼ˆ-p è¡¨ç¤º print/éžäº¤äº’æ¨¡å¼ï¼‰
            if claude -p "$(cat .kiro/specs/tasks.md)"; then
              echo ""
              echo "âœ… æ‰§è¡ŒæˆåŠŸï¼"
              SUCCESS=true
              break
            else
              EXIT_CODE=$?
              echo ""
              echo "âŒ æ‰§è¡Œå¤±è´¥ (é”™è¯¯ç : $EXIT_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åŽé‡è¯•..."
                sleep $RETRY_DELAY
                echo ""
              fi
            fi
          done

          echo ""
          echo "========================================="
          if [ "$SUCCESS" = true ]; then
            echo "   âœ… ä»»åŠ¡å®Œæˆ"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 0
          else
            echo "   âŒ ä»»åŠ¡å¤±è´¥ï¼ˆå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼‰"
            echo "========================================="
            echo "ç»“æŸæ—¶é—´: $(TZ='Asia/Shanghai' date)"
            exit 1
          fi

      - name: ä¸Šä¼ ä»»åŠ¡ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-results-${{ github.run_number }}
          path: |
            *.txt
            *.log
            *.md
          retention-days: 7

      - name: è¾“å‡ºé€šçŸ¥ä¿¡æ¯ï¼ˆæˆåŠŸï¼‰
        if: success()
        run: |
          echo "âœ… æŠ€æœ¯æ–‡ç« åˆ†æžå®Œæˆï¼"
          echo "è¿è¡Œç¼–å·: #${{ github.run_number }}"
          echo "å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo ""
          echo "ðŸ“Š æŸ¥çœ‹è¯¦æƒ…ï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ“¦ ä¸‹è½½åˆ†æžæŠ¥å‘Šï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          echo ""
          echo "ðŸ’¡ é€šçŸ¥æ–¹å¼ï¼š"
          echo "1. GitHub ç½‘é¡µé€šçŸ¥ï¼ˆå¦‚æžœå¼€å¯äº† Watchï¼‰"
          echo "2. è®¿é—® Actions é¡µé¢æŸ¥çœ‹æœ€æ–°ç»“æžœ"

      - name: è¾“å‡ºé€šçŸ¥ä¿¡æ¯ï¼ˆå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "âŒ æŠ€æœ¯æ–‡ç« åˆ†æžå¤±è´¥ï¼"
          echo "è¿è¡Œç¼–å·: #${{ github.run_number }}"
          echo "å¤±è´¥æ—¶é—´: $(TZ='Asia/Shanghai' date)"
          echo ""
          echo "ðŸ” æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
